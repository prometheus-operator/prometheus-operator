apiVersion: monitoring.coreos.com/v1
kind: Prometheus
metadata:
  name: prometheus-azure-workload-identity
  namespace: monitoring
spec:
  replicas: 2
  serviceAccountName: prometheus
  image: prom/prometheus:v3.7.0

  # Configure remote write to Azure Monitor with Workload Identity authentication
  remoteWrite:
    - url: https://example.azuremonitor.com/metrics/write
      
      # Azure AD configuration with Workload Identity
      azuread:
        # Azure Cloud environment
        cloud: AzurePublic
        
        # Workload Identity configuration
        # This requires:
        # - Prometheus >= v3.7.0
        # - Azure Workload Identity webhook configured in the cluster
        # - Service Account bound to Azure Managed Identity via Workload Identity
        workloadIdentity:
          # Azure AD tenant ID
          tenantId: "xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"
          
          # Azure AD application (client) ID
          clientId: "yyyyyyyy-yyyy-yyyy-yyyy-yyyyyyyyyyyy"

      # Optional: Configure remote write parameters
      writeRelabelConfigs:
        - sourceLabels: [__name__]
          regex: 'prometheus_.*'
          action: drop

  # Pod monitoring configuration
  serviceMonitorSelectorNilUsesHelmValues: false
  
  # Prometheus storage configuration
  storage:
    tsdb:
      outOfOrderTimeWindow: 30m

---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: prometheus
  namespace: monitoring
  annotations:
    # Annotation required for Workload Identity binding
    azure.workload.identity/client-id: "yyyyyyyy-yyyy-yyyy-yyyy-yyyyyyyyyyyy"

---
# Additional configuration for Azure Workload Identity:
# 1. Configure the Kubernetes service account with the annotation above
# 2. Create an Azure User-Assigned Managed Identity
# 3. Create a federated identity credential linking:
#    - Azure Managed Identity
#    - Kubernetes Service Account
#    - Namespace and ServiceAccount name
#
# Example commands:
#
# az identity create --resource-group myResourceGroup --name myManagedIdentity
# 
# az identity federated-credential create \
#   --name myFederatedCredential \
#   --identity-name myManagedIdentity \
#   --resource-group myResourceGroup \
#   --issuer https://oidc.prod-aks.azure.com/[SUBSCRIPTION_ID]/[RESOURCE_GROUP]/[CLUSTER_NAME] \
#   --subject system:serviceaccount:monitoring:prometheus
#
# For more information about Workload Identity, see:
# https://azure.microsoft.com/en-us/blog/workload-identity-for-kubernetes-is-now-generally-available/
